name: Prepend JIRA Ticket to PR Title

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  update-pr-title:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Extract JIRA Ticket
        id: extract
        run: |
          set -e  # Exit immediately if a command exits with a non-zero status.
          
          # Get the branch name
          echo "Branch name: ${{ github.head_ref }}"
          BRANCH_NAME="${{ github.head_ref }}"

          # Extract JIRA ticket number and prefix (assuming format like "feature/ABC-1234-description")
          JIRA_TICKET=$(echo "$BRANCH_NAME" | grep -oE '[A-Z]+-[0-9]+')

          if [ $? -ne 0 ]; then
            echo "Error: Failed to extract JIRA ticket from branch name."
            exit 1
          fi

          # Debugging output
          echo "Extracted JIRA ticket: $JIRA_TICKET"

          # Save the JIRA ticket to a file if it exists
          if [ -n "$JIRA_TICKET" ]; then
            echo "JIRA_TICKET=$JIRA_TICKET" >> $GITHUB_ENV
          else
            echo "No JIRA ticket found in branch name."
            echo "JIRA_TICKET=" >> $GITHUB_ENV
          fi

      - name: Update PR Title
        if: env.JIRA_TICKET != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JIRA_TICKET: ${{ env.JIRA_TICKET }}
        run: |
          set -e  # Exit immediately if a command exits with a non-zero status.

          # Fetch the current PR title
          PR_TITLE=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} \
            | jq -r .title)

          if [ $? -ne 0 ]; then
            echo "Error: Failed to fetch the current PR title."
            exit 1
          fi

          #

